<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- CSS only -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <link href="./style.css" rel="stylesheet">
  <title>Web-Usability</title>
</head>

<body class="min-vw-100">
  <div class="modal fade " id="task-stats">
    <div class="modal-dialog modal-dialog-centered modal-xl">
      <div class="modal-content" style="height:90vh">
        <div class="modal-header">
          <h5 class="modal-title" id="staticBackdropLabel">Stats</h5>
        </div>
        <div class="modal-body">
          <div class="row">
            <div id="videoPlayer" class="box col-8" style="height:70vh;">

            </div>
            <div class="box col-4" style="height:70vh;">
              <div class="box" style="height:60%; overflow-y:scroll ;">
                <ul id="remarks">

                </ul>
              </div>
              <div id="add_remark" class="box" style="height:40%;">
                <form id="remark-form" request="test/remark/">
                  <div class="form-group">
                    <textarea class="form-control" id="remark" rows="4" cols="50" name="remark"
                      placeholder="Add a remark"></textarea>
                  </div>
                  <button type="submit" class="btn btn-primary me-2 py-2">Add</button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <nav class="navbar navbar-light bg-light">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">
        <img src="/docs/5.0/assets/brand/bootstrap-logo.svg" alt="" width="30" height="24"
          class="d-inline-block align-text-top">
        International Institute of Information And Technology, Hyderabad
      </a>
      <div class="navbar-brand d-flex">
        <button class="btn me-2 btn-outline-success" type="submit">Search</button>
        <button class="btn me-2 btn-outline-success" type="submit">Search</button>
      </div>
    </div>
  </nav>
  <div class="modal fade project-register-form" role="dialog" style="height:80vh;top:80px">
    <div class="modal-dialog modal-md">
      <div class="modal-content">
        <div class="modal-header">
          <h4>Add a Project</h4>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="registrationDiv">
            <form id="participant-add-form" request="test/create/">
              <div class="form-group">
                <label for="name">Participant Email:</label>
                <input type="email" class="form-control" id="email" placeholder="Enter email-name" name="email">
              </div>
              <div class="form-group">
                <label for="time">Scheduled Time:</label>
                <input type="datetime-local" class="form-control" id="time" placeholder="Time" name="time">
              </div>
  
              
              <hr>
              <button type="submit" class="btn btn-primary me-2">Register</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="contentPanel" class="row justify-content-start">
    <div class="col-4">
      <h3 id="projectName"></h3>
      <div id="projectDetails" class="box col">
        <p id="projectURL" class="col"></p>
        <p id="projectDescription" class="col"></p>
      </div>
      <div id="projectStats" class="box col">
      </div>
    </div>
    <div class="col-8 ">
      <div id="tasks" class="row box px-4 py-4">
        <div class="row justify-content-between">
          <div class="col-3 ">
            <h4>Tests:</h4>
          </div>
          <div class="col-3"><button id="addParticipant"
              class="projectItem btn me-5 btn-success align-self-end" type="submit" data-bs-toggle="modal"
              data-bs-target=".project-register-form">+ Add Participant</button>
          </div>
        </div>
        <hr>
        <div id="taskList" class="row col-4">

        </div>
      </div>

    </div>

  </div>
  <footer id="footer">
    <div class="container-fluid">
      <div class="row-fluid" style="margin-top: 20px;font-size: 13px;">
        <div class="container">
          <div class="copyright">Â© <span id="copyright-year">2021-2022</span> Software Engineering Research Center
            (SERC), IIIT-Hyderabad.</div>
        </div>
      </div>
    </div>
    </div>
  </footer>

  <script src="https://code.jquery.com/jquery-3.6.0.slim.js"
    integrity="sha256-HwWONEZrpuoh951cQD1ov2HUK5zA5DwJ1DNUXaM6FsY=" crossorigin="anonymous"></script>
  <!-- CSS only -->
  <!-- JavaScript Bundle with Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
    crossorigin="anonymous"></script>
  <script> //$('.carousel').carousel(); 
    var user_email = sessionStorage.getItem('user_email');
    var user_type = sessionStorage.getItem('user_type');
    var server_address = sessionStorage.getItem('server_address');
    var token = sessionStorage.getItem('token');
    var project_id = sessionStorage.getItem('project_id');
    var project_name = sessionStorage.getItem('project_name');
    var task_id = sessionStorage.getItem('task_id');
    var task_name = sessionStorage.getItem('task_name');
    var task_description = sessionStorage.getItem('task_description');
    var task_url = sessionStorage.getItem('task_url');
    var video_url = "";
    var test_id="";
    url = "";

    url = server_address + "test/";

    url = url + project_id + "/" + task_id;
    async function getResponse(urll) {
      console.log(urll);
      const fetchOptions = {
        method: "GET",
        headers: {
          "Content-Type": "application/json",
          "Accept": "application/json",
          "Authorization": "token " + token
        }
      };
      try {
        let response = await fetch(urll, fetchOptions);
        console.log(response);
        return await response.json();
      } catch (err) {
        console.error(err);
      }
    }
    function showTestStats(id){
      $("#remarks").append('<li>' + task_list_object[id]["remark"] + '</li>');
      video_url = task_list_object[id]["video_url"] ;
      test_id = task_list_object[id]["_id"];
    }

    const wraper = async function () {
      const responseTestsList = await getResponse(url);
      const taskInfo = await getResponse(server_address + "task/" + task_id);

      var task_list_object = responseTestsList
      var task_info_object = taskInfo;
      console.log(responseTestsList);
      console.log(taskInfo);

      tmp = '';
      $.each(task_list_object, function (key, value) {
        //console.log(o);
        var i = 0;
        tmp += '<button class="projectItem card btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#task-stats" onclick="showTestStats('+ (i++) +')">';
        tmp += '<h6 class="card-title">' + value.participant_name + '</h6>';
        tmp += '<p class="card-text"><small class="text-muted">' + value.start_time + '</small></p>';
        tmp += '</button>';
      });
     
      $('#taskList').prepend(tmp);
      $('#projectURL').prepend(task_info_object["URL"]);
      $('#projectDescription').prepend(task_info_object["description"]);
      $('#projectName').prepend(project_name + "/ " + task_name);

    }

    wraper();
   
    var task_remarks_list = ['sonething sothong','other thing ','varioed varied','sppuerrrr'];

    const remarkForm = document.getElementById("remark-form");
    remarkForm.addEventListener("submit", handleSubmitRemark);

    async function handleSubmitRemark(event) {
      event.preventDefault();
      const form = event.currentTarget;
      request = form.getAttribute("request")
      url_post = server_address + request;
      if(request=="test/remark/"){
        url_post = url_post + test_id;
      }
      try {
        var formData = new FormData(form);
        formData.append("project_id",project_id);
        formData.append("task_id",task_id);
        const responseObj = await postFormDataAsJson(url_post, formData);
        $("#remarks").append('<li>' + formData.get("remark") + '</li>');
        $('#remark').val('');
      } catch (error) {
        console.error(error);
      }
    }
    async function postFormDataAsJson(url, formData) {
      const plainFormData = Object.fromEntries(formData.entries());
      const formDataJsonString = JSON.stringify(plainFormData);
      console.log(formDataJsonString);
      const fetchOptions = {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Accept": "application/json",
          "Authorization": "token " + token
        },
        body: formDataJsonString,
      };
      const response = await fetch(url, fetchOptions);
      if (!response.ok) {
        const errorMessage = await response.text();
        throw new Error(errorMessage);
      } 
      return response;
    }
    
    
    
    // var responseTestsList ='[{"participant_name":"Spider Man","start_time":"12/11/21, Monday"},{"participant_name":"Bat Man","start_time":"12/11/21, Monday"},{"participant_name":"Super Man","start_time":"12/11/21, Monday"}]'
    // var responseTaskInfo ='[{"URL":"www.iith.ac.in/taskpage", "description":"Perform some task. and work towards work-related goals. Achieve all project goals. "}]'
    
    // var task_info_object = JSON.parse( responseTaskInfo )[0];
    // var task_list_object = JSON.parse(responseTestsList);
    // tmp='';
    // var i=0;
    // $.each( task_list_object, function(key, value) {
    //   //console.log(o);
    //   tmp += '<button class="projectItem card btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#task-stats" onclick="showTestStats('+ (i++) +')">';
    //   tmp +=       '<h6 class="card-title">'+value.participant_name+'</h6>';
    //   tmp +=       '<p class="card-text"><small class="text-muted">'+value.start_time+'</small></p>';
    //   tmp += '</button>';
    // });
   
   

    // $('#taskList').prepend(tmp);
    // $('#projectURL').prepend(task_info_object["URL"]);
    // $('#projectDescription').prepend(task_info_object["description"]);
    // $('#projectName').prepend(project_name+"/ "+task_name);
  </script>

</body>

</html>
